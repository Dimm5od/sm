<!DOCTYPE html>
<html lang="ru" xmlns="http://www.w3.org/1999/html">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- <meta http-equiv="Content-Security-Policy"
            content="default-src 'none';
            manifest-src 'self';
            script-src 'self' 'nonce-c13d9af436';
             connect-src https://cptp.exima-online.net/smemo/ https://nakleyka.com.ua/smemo/;
            style-src 'self';
            img-src 'self' data:;
            base-uri 'none';
            object-src 'none';"> -->
    <link rel="icon" type="image/png" href="favicon.png">
    <link rel="stylesheet" href="css/main.css?v2">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#3367D6">
    <link rel="apple-touch-icon" href="icons/icon-512.png">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <script src="js/main.js"></script>
    <title>My Notes</title>

</head>
<body>

<div class="container">

    <!-- Поле с информацией о логине, показывается после авторизации-->
    <div id="loginInfo" class="hidden flex">
        <div class="left-buttons">
            <button id="btnNew" class="small">Добавить запись</button>
            <button id="btnTextArea" class="small align-left">#</button>
        </div>
        <div class="align-right">
            ID: <a href="#" id="lnkLogout"><span id="secretIcons"></span></a>
        </div>
    </div>

    <!-- Форма авторизации -->
    <div id="loginArea" class="hidden">

        <div class="flex">
            <h2>Secure Notes Client</h2>
            <div class="align-right">
                <button class="normal hidden" id="btnLogout">Logout</button>
            </div>
        </div>

        <form id="loginForm">

            <label for="passphrase">Секретная фраза: <span id="secretIcons2"></span></label>
            <div class="password-wrapper">
                <input type="password" id="passphrase" placeholder="Введите вашу секретную фразу" required
                       value=""><span class="password-toggle" id="toggle" data-toggle="passphrase">&#128065;</span>
            </div>
            <div id="lnkSettings">[ <a href="#">Дополнительные настройки...</a> ]</div>

            <!-- Блок настроек -->
            <div id="settingsArea" class="hidden">
                <br>
                <label for="apiServer">Выберите сервер:</label>
                <select id="apiServer">
                    <option value="https://cptp.exima-online.net/smemo/api.php" selected>Основной сервер</option>
                    <option value="https://nakleyka.com.ua/smemo/api.php">Экспериментальный сервер</option>
                </select>
                <input type="checkbox" id="savePassphrase" value="1" class="small"> <label for="savePassphrase">Сохранить
                секретную фразу</label><br>
                <span class="description">Фраза будет сохранена локально в sessionStorage браузера (между перезагрузками страницы, только для этой вкладки и только до закрытия вкладки в браузере)</span>
                <br>
                <input type="checkbox" id="enableHistory" value="1" class="small"> <label for="enableHistory">Сохранять
                историю страниц</label><br>
                <span class="description">В истории браузера будет видна ваша активность с заметками. Позволяет использовать кнопки "назад" браузера</span>
                <br>
                <input type="checkbox" id="enableDebug" value="1" class="small"> <label for="enableDebug">Включить
                отладку</label><br>
                <span class="description">Скрипт будет показывать все запросы к серверу его ответы, а так же выводить отладочную информацию в консоль. Не рекомендуется для обычного использования.</span>

            </div>

            <button type="submit" class="actionBtn">Применить / Войти</button>
        </form>
    </div>

    <div id="actionsArea" class="hidden">
        <button id="passwdBtn" type="button" disabled>Изменить парольную фразу</button>
        <br>
        <button id="exportBtn" type="button" disabled>Экспорт данных</button>
        <br>
        <button id="importBtn" type="button" disabled>Импорт данных</button>
        <br>
        <button id="backupBtn" type="button" disabled>Скачать бекап</button>
        <br>
        <button id="restoreBtn" type="button" disabled>Восстановить бекап</button>
        <br>
        <button id="terminateAccountBtn" type="button" class="color-red" disabled>Удалить все данные</button>
        <br>
    </div>

    <div id="exportArea" class="hidden">
        <h3>Результаты экспорта</h3>
        <label for="exportTextArea"><span class="description">Скопируйте и сохраните ваши данные на свое устройство для дальнейшего использования</span></label>
        <textarea id="exportTextArea" rows="15"></textarea>
        <br>
        <button id="copyExportBtn" type="button" class="small">Скопировать в буфер</button>
        <button id="saveExportBtn" type="button" class="small actionBtn">Сохранить в файл</button>
        <br>
        <button id="closeExportBtn" type="button">Вернуться в настройки</button>
        <br><br>
    </div>

    <div id="importArea" class="hidden">
        <h3>Импорт данных</h3>
        <label for="importTextArea"><span class="description">Вставьте текст в формате JSON. Должны присутствовать поля title, tags, text. Остальные поля будут проигнорированы. Записи будут ДОБАВЛЕНЫ к вашим существующим.</span></label>
        <textarea id="importTextArea" rows="15">[
  {
    "title": "Заголовок заметки",
    "tags": "тег1, тег2",
    "text": "Текст заметки"
  },
    {
    "title": "Вторая заметки",
    "tags": "тег2, тест",
    "text": "Содержимое второй заметки"
  }
 ]</textarea>
        <pre id="importLog" class="hidden"></pre>
        <div class="import-controls">
            <button id="pasteImportBtn" type="button" class="small">Вставить из буфера</button>
            или <input type="file" id="fileInput" accept=".txt,.json">
        </div>
        <button id="doImportBtn" class="actionBtn" type="button">Выполнить импорт</button>
        <button id="closeImportBtn" type="button">Вернуться в настройки</button>
        <br><br>
    </div>

    <div id="restoreArea" class="hidden">
        <h3>Восстановление бекапа</h3>
        <div class="description">Внимание: восстановление <span class="color-red">удалит все существующие данные</span>
            и заменит их данными из выбранного вами бекапа!<br></div>
        <div id="backupInfo">файл бекапа не выбран</div>
        <input type="file" id="fileInputBackup" accept=".gz">
        <button id="doRestoreBtn" type="button" disabled>Восстановить бекап</button>
        <button id="doDecryptBtn" type="button" disabled>Расшифровать и экспортировать данные</button>
        <button id="closeRestoreBtn" type="button">Вернуться в настройки</button>
        <br><br>
    </div>


    <div id="textArea" class="hidden">
        <h3>Шифрование текста</h3>
        Текущая фраза: <span id="textAreaIcons"></span><br>
        <label for="encodeTextArea"><span
                class="description">Вставьте текст, который нужно зашифровать / расшифровать</span></label>
        <textarea id="encodeTextArea" rows="15"></textarea>
        <div class="import-controls">
            <button id="pasteTextBtn" type="button" class="small">Вставить</button>
            <button id="copyTextBtn" type="button" class="small">Скопировать</button>
            <button id="clearTextBtn" type="button" class="small">Очистить</button>
        </div>
        <div class="flex gap">
            <button id="doEncodeTextBtn" type="button" class="width50">Зашифровать</button>
            <button id="doDecodeTextBtn" type="button" class="width50">Раскодировать</button>
        </div>
        <button id="closeTextBtn" type="button">Вернуться</button>
        <br><br>
    </div>

    <!-- форма поиска, показывается все время после авторизации -->
    <div id="searchArea" class="hidden">
        <form id="searchForm" autocomplete="off">
            <label for="searchQuery"></label><input type="text" id="searchQuery" placeholder="Поиск..." required enterkeyhint="search"/>
            <button type="submit" id="searchBtn">Искать</button>
        </form>
        <div id="searchResultsList"></div>
    </div>

    <div id="viewArea" class="hidden">
        <div id="viewActionButtons" class="align-right">
            <button id="btnActionClose" class="small">Закрыть</button>
            <button id="btnActionEdit" class="small">Правка</button>
            <button id="btnActionDelete" class="color-red small">Удалить</button>
        </div>
        <div class="page-header">
            <div id="viewDate" class="noteDate"></div>
            <h3 id="viewTitle"></h3>
        </div>
        <div id="viewContent"></div>
        <div id="viewTags"></div>
    </div>

    <div id="editArea" class="hidden">
        <h3 id="editTitle">Новая запись</h3>
        <form id="editForm" autocomplete="off">
            <input type="hidden" id="editId">
            <label>Заголовок:<br><input type="text" id="editTitleInput" tabindex="1"></label>
            <label>Теги:<br><input type="text" id="editTagsInput" tabindex="2"></label>
            <label>Текст:<br><textarea id="editTextInput" tabindex="3"></textarea></label>
            <button type="submit" class="small actionBtn" tabindex="4">Сохранить</button>
            <button type="button" class="small" id="btnCancelEdit" tabindex="5">Отменить</button>
        </form>
    </div>

    <div id="passwdArea" class="hidden">
        <h2>Изменение секретной фразы</h2>
        <label for="passphrase1">Старая фраза: <span id="secretIcons3"></span></label>
        <div class="password-wrapper">
            <input type="password" id="passphrase1" placeholder="Введите старую фразу" required
                   value="" readonly><span
                class="password-toggle" id="toggle3" data-toggle="passphrase1">&#128065;</span>
        </div>

        <label for="passphrase2">Новая фраза: <span id="secretIcons4"></span></label>
        <div class="password-wrapper">
            <input type="password" id="passphrase2" placeholder="Введите новую фразу" required
                   value=""><span
                class="password-toggle" id="toggle4" data-toggle="passphrase2">&#128065;</span>
        </div>
        <button type="button" id="btnDoPasswd" class="actionBtn">Изменить секретную фразу</button>
        <button type="button" id="btnCancelPasswd">Отменить</button>
    </div>

    <div id="helpArea" class="hidden">
        <b>1. Что это такое?</b><br>
        Тут ответы на все вопросы этой жизни. Тут ответы на все вопросы этой жизни Тут ответы на все вопросы этой
        жизни<br>
        <br>
        <b>2. Зачем это нужно?</b><br>
        Тут ответы на все вопросы этой жизни. Тут ответы на все вопросы этой жизни Тут ответы на все вопросы этой жизни.
        Тут
        ответы на все вопросы этой жизни. Тут ответы на все вопросы этой жизни<br>
        <br>
    </div>

    <b id="debugToggle" class="hidden">Отладка ▼</b>
    <div id="debug" class="hidden"></div>

    <script nonce="c13d9af436">
        // === Глобальные переменные ===
        let aesKey, secretKey, login, ENC, apiUrl, activeArea;

        let isLoggedIn = false; // флаг, выполнен ли вход
        let debugIsOn = false;
        let saveHistory = false; // По умолчанию история в браузере и возможность hash навигации отключены

        // === Показываем иконки при вводе passphrase ===
        document.getElementById('passphrase').addEventListener('input', async () => {
            const value = document.getElementById('passphrase').value;
            let icons = '';
            if (value) icons = sha256ToIcons(await sha256(value), 4);
            document.getElementById('secretIcons').textContent = icons; // выводим результат
            document.getElementById('secretIcons2').textContent = icons; // выводим результат
        });
        document.getElementById('passphrase1').addEventListener('input', async () => {
            const value = document.getElementById('passphrase1').value;
            document.getElementById('secretIcons3').textContent = sha256ToIcons(await sha256(value), 4);
        });
        document.getElementById('passphrase2').addEventListener('input', async () => {
            const value = document.getElementById('passphrase2').value;
            document.getElementById('secretIcons4').textContent = sha256ToIcons(await sha256(value), 4);
        });

        // Сохранение и загрузка выбранного пользователем сервера
        const selectApiServer = document.getElementById('apiServer');
        selectApiServer.addEventListener('change', function () {
            localStorage.setItem('apiServer', this.value);
        });
        const savedApiServer = localStorage.getItem('apiServer');
        // Проверяем, что бы значение из localStorage было корректным. Если его нет среди options - используем дефолтное, то что selected в options
        if (savedApiServer && [...selectApiServer.options].some(o => o.value === savedApiServer)) {
            selectApiServer.value = savedApiServer;
        } else {
            localStorage.setItem('apiServer', selectApiServer.value);
        }

        // Сохранение и загрузка настройки "Отладка"
        const checkboxEnableDebug = document.getElementById('enableDebug');
        checkboxEnableDebug.addEventListener('change', function () {
            const v = (checkboxEnableDebug.checked) ? '1' : '0';
            localStorage.setItem('enableDebug', v);
            debugIsOn = (v === '1'); // обновим глобальную переменную
            if (debugIsOn) {
                document.getElementById('debugToggle').classList.remove('hidden');
            } else {
                document.getElementById('debugToggle').classList.add('hidden');
                document.getElementById('debug').classList.add('hidden');
            }
        });
        debugIsOn = (localStorage.getItem('enableDebug') === '1'); // восстановим глобальную переменную
        checkboxEnableDebug.checked = debugIsOn; // установим / снимем галочку в форме настроек
        if (debugIsOn) { // покажем форму отладки при загрузке страницы
            document.getElementById('debugToggle').classList.remove('hidden');
        }
        // обработчик toggle отладки
        document.getElementById('debugToggle').addEventListener('click', function () {
            const debug = document.getElementById('debug');
            const isHidden = debug.classList.contains('hidden');
            debug.classList.toggle('hidden', !isHidden);
            this.textContent = isHidden ? 'Отладка ▲' : 'Отладка ▼';
        });

        // Сохранение и загрузка настройки "сохранить историю"
        const checkboxEnableHistory = document.getElementById('enableHistory');
        checkboxEnableHistory.addEventListener('change', function () {
            const v = (checkboxEnableHistory.checked) ? '1' : '0';
            localStorage.setItem('enableHistory', v);
            saveHistory = (v === '1'); // обновим глобальную переменную
        });
        saveHistory = (localStorage.getItem('enableHistory') === '1'); // восстановим глобальную переменную
        checkboxEnableHistory.checked = saveHistory; // установим / снимем галочку в форме настроек

        // Сохранение и загрузка настройки "сохранить парольную фразу"
        const checkboxSavePassphrase = document.getElementById('savePassphrase');
        checkboxSavePassphrase.addEventListener('change', function () {
            const v = (checkboxSavePassphrase.checked) ? '1' : '0';
            localStorage.setItem('savePassphrase', v);
            if (v === '0') {
                sessionStorage.removeItem('passphrase'); // Удалим фразу из хранилища
            }
        });
        const savedSavePassphrase = localStorage.getItem('savePassphrase');
        checkboxSavePassphrase.checked = (savedSavePassphrase === '1');
        if (savedSavePassphrase === '1') {
            // Попробуем загрузить фразу из sessionStorage
            let savedPassphrase = sessionStorage.getItem('passphrase');
            if (savedPassphrase) {
                document.getElementById('passphrase').value = savedPassphrase;
                document.getElementById('passphrase').dispatchEvent(new Event('input', {bubbles: true}));
            }
        }

        // Автоматический вход если сохранена passphrase на случай перезагрузки страницы
        if (document.getElementById('passphrase').value) {
            let passphrase = document.getElementById('passphrase').value;
            if (!passphrase) {
                alert('Секретная фраза не найдена!');
            } else {
                doLogin(passphrase);
            }
        } else {
            // покажем форму логина
            switchTo('loginArea');
        }

        const textPleaseLoginFirst = 'Ошибка: вход не выполнен!\n\nПеред выполнением этого действия нужно войти на сервер!';

        // === Account termination ===
        document.getElementById('terminateAccountBtn').onclick = async (e) => {
            e.preventDefault();
            if (!isLoggedIn || !login) {
                alert(textPleaseLoginFirst);
                return;
            }
            if (confirm('Удаление аккаунта\n\nВы собираетесь безвозвратно удалить все ваши записи и регистрацию на сервере\n\nЭто действие не может быть отменено, все данные будут удалены без возможности восстановления\n\n\nХотите продолжить?')) {
                if (confirm('Последнее предупреждение. Вы уверены?')) {
                    const res = await sendRequest('terminate', {}, apiUrl, login, secretKey);
                    if (res && typeof res === 'object' && res.ok === true) {
                        alert('Ваша регистрация и все данные удалены с сервера');
                    } else {
                        showError('Удаление данных', res);
                    }
                }
            }
        }

        // === Show crypt / decrypt text form ===
        document.getElementById('btnTextArea').onclick = (e) => {
            e.preventDefault();
            document.getElementById('textAreaIcons').textContent = document.getElementById('secretIcons').textContent;
            switchTo(['textArea']);
        }

        // === Close crypt / decrypt text form ===
        document.getElementById('closeTextBtn').onclick = (e) => {
            e.preventDefault();
            document.getElementById('encodeTextArea').value = ''; // очистка формы
            switchTo(['searchArea', 'loginInfo']);
            document.getElementById('searchQuery').focus();
        }

        // === Crypt text ===
        document.getElementById('doEncodeTextBtn').onclick = async (e) => {
            e.preventDefault();
            const area = document.getElementById('encodeTextArea');
            if (area.value === '') {
                return;
            }
            area.value = await encryptText(area.value, aesKey);
        }

        // === Decrypt text ===
        document.getElementById('doDecodeTextBtn').onclick = async (e) => {
            e.preventDefault();
            const area = document.getElementById('encodeTextArea');
            if (area.value === '') {
                return;
            }
            area.value = await decryptText(area.value, aesKey);
        }

        // === Copy text btn ===
        document.getElementById('copyTextBtn').onclick = async (e) => {
            e.preventDefault();
            const area = document.getElementById('encodeTextArea');
            await navigator.clipboard.writeText(area.value);
        }

        // === Paste text btn ===
        document.getElementById('pasteTextBtn').onclick = async (e) => {
            e.preventDefault();
            const area = document.getElementById('encodeTextArea');
            area.value = await navigator.clipboard.readText();
        }

        // === Clear text btn ===
        document.getElementById('clearTextBtn').onclick = async (e) => {
            e.preventDefault();
            document.getElementById('encodeTextArea').value = '';
        }

        // === System settings ===
        document.getElementById('lnkSettings').onclick = (e) => {
            e.preventDefault();
            switchTo(['loginArea', 'settingsArea', 'actionsArea']);
        }

        // === Login Settings ===
        document.getElementById('lnkLogout').onclick = (e) => {
            e.preventDefault();
            document.getElementById('searchResultsList').textContent = ''; // очистим результаты поиска
            switchTo("loginArea");
            setHash('settings');
        }

        // === Logout button ===
        document.getElementById('btnLogout').onclick = (e) => {
            e.preventDefault();
            document.getElementById('passphrase').value = '';
            sessionStorage.removeItem('passphrase');
            document.getElementById('secretIcons').textContent = '';
            document.getElementById('secretIcons').textContent = '';
            document.getElementById('secretIcons2').textContent = '';
            login = false;
            secretKey = false;
            aesKey = false;
            ENC = false;
            isLoggedIn = false;
            document.getElementById('btnLogout').classList.add('hidden');
            document.getElementById('passwdBtn').disabled = true;
            document.getElementById('exportBtn').disabled = true;
            document.getElementById('importBtn').disabled = true;
            document.getElementById('backupBtn').disabled = true;
            document.getElementById('restoreBtn').disabled = true;
            document.getElementById('terminateAccountBtn').disabled = true;
        }

        // === Passwd show form ===
        document.getElementById('passwdBtn').onclick = async (e) => {
            e.preventDefault();
            if (!isLoggedIn || !login) {
                alert(textPleaseLoginFirst);
                return;
            }
            document.getElementById('passphrase1').value = document.getElementById('passphrase').value;
            document.getElementById('passphrase1').dispatchEvent(new Event('input', {bubbles: true}));
            switchTo("passwdArea");
        }

        // === Passwd Close button
        document.getElementById('btnCancelPasswd').onclick = (e) => {
            e.preventDefault();
            document.getElementById('passphrase1').value = '';
            document.getElementById('passphrase2').value = '';
            document.getElementById('secretIcons4').textContent = '';
            switchTo(['loginArea', 'settingsArea', 'actionsArea']);
        }

        // === Passwd process
        document.getElementById('btnDoPasswd').onclick = async (e) => {
            e.preventDefault();
            if (!isLoggedIn || !login) {
                alert(textPleaseLoginFirst);
                return;
            }

            const newPassphrase = document.getElementById('passphrase2').value;

            if(newPassphrase === ''){
                alert('Введите новую секретную фразу!');
                return false;
            }

            if(newPassphrase === document.getElementById('passphrase1').value){
                alert('Новая фраза должна отличаться от старой!');
                return false;
            }

            if (!confirm('Важно: процедура изменение парольной фразы:\n\n1. Создаем аккаунт с новым ключом\n2. Получаем зашифрованные данные со старого аккаунта\n3. Расшифровуем полученные данные\n4. Шифруем данные с новым ключом\n5. Удаляем все существующие данные в НОВОМ аккаунте (если есть)\n6. Загружаем зашифрованные данные в новый аккаунт.\n7. Удаляем старый аккаунт со всеми данными\n\nРекомендуем сейчас прервать процесс и сохранить резервную копию, если вы этого не сделали ранее.\n\nЕсли резервная копия у вас уже есть - нажмите ОК, иначе Отмена')) {
                return;
            }

            // проверяем вход (и выполняем регистрацию если нужно) с новым логином
            const [newLogin, newSecretKey, newAesKey, newENC] = await genKeys(newPassphrase);
            if (debugIsOn) console.log(`Passwd from ${login} to ${newLogin} with key ${newSecretKey}`);

            let res = await sendRequest('login', {}, apiUrl, newLogin, newSecretKey);
            if (res && typeof res === 'object' && res.ok === true) {
                if (debugIsOn) console.log(`Вход выполнен на ${apiUrl} как ${newLogin}, записей в базе: ${res.records}`);
                if (res.records > 0) {
                    if (!confirm(`Внимание: в аккаунте С НОВОЙ фразой сейчас уже есть ${res.records} записей\n\n Они будут УДАЛЕНЫ!\n\nХотите продолжить?`)) {
                        return;
                    }
                }
            } else if (res && typeof res === 'object' && res.error === 'user_not_registered') {
                if (res.signup === 1) {
                    if (!await doSignup(apiUrl, newLogin, newSecretKey, {noConfirm: true})) {
                        // Ошибка регистрации
                        return false;
                    }
                } else {
                    // Пользователь не зарегистрирован, регистрация не разрешена
                    alert("Не получается создать нового пользователя, т.к. сервер не разрешает новые регистрации");
                    if (debugIsOn) console.warn(`Пользователь ${newLogin} с ключом ${newSecretKey} не существует на сервере ${apiUrl}. Регистрация не доступна.`);
                    return false;
                }
            } else {
                showError("Login error", res);
                return false;
            }

            let totalCount, importedRecords;

            const btn = document.getElementById('btnDoPasswd');

            // Заблокируем кнопку на время обработки
            btn.disabled = true;
            btn.classList.remove('actionBtn');
            btn.textContent = `Обработка: 0 из ${totalCount}`;
            document.getElementById('btnCancelPasswd').disabled = true;

            // экспорт данных со старого логина
            /**
             * @typedef {Object} backupResponse
             * @property {string} filecontent
             * @property {boolean} ok
             * @property {string} filename
             * @property {number} count
             */

            /** @type {backupResponse} */
            res = await sendRequest('backup', {}, apiUrl, login, secretKey);
            if (res && typeof res === 'object' && res.ok === true) {
                const u8 = Uint8Array.from(atob(res.filecontent), c => c.charCodeAt(0));
                let text = await ungzip(u8);
                try {
                    text = JSON.parse(text);
                } catch (e) {
                    console.warn('Invalid JSON:', text.slice(0, 300) + '...');
                    alert('Ошибка обработки, не валидный JSON в бэкапе данных!');
                    resetPasswdBtn();
                    return;
                }

                totalCount = res.count; // Всего записей для переноса


                let i = 0;
                const data = []; // массив со всеми записями для загрузки на сервер через passwd
                for (const n of text.content) {
                    i++;
                    // Расшифровка полученных данных
                    const title = await decryptText(n.rtitle, aesKey);
                    const tags = await decryptText(n.rtags, aesKey);
                    const text = await decryptText(n.content, aesKey);

                    // Добавляем запись в новый логин
                    // Кодируем данные и добавляем в список
                    data.push({
                        uid: n.uid,
                        title: await newENC.encodeForIndex(title),
                        rtitle: await encryptText(title, newAesKey),
                        content: await encryptText(text, newAesKey),
                        tags: await newENC.encodeForIndex(tags),
                        rtags: await encryptText(tags, newAesKey),
                        date_created: n.date_created,
                        date_modified: n.date_modified
                    });

                    // обновим процент выполнения
                    btn.textContent = `Обработка: ${i} из ${totalCount}`;
                }

                // Загрузка результатов на сервер
                btn.textContent = `Загрузка новых данных на сервер...`;
                const b64content = base64encode(JSON.stringify(data));
                res = await sendRequest('restore', {content: b64content}, apiUrl, newLogin, newSecretKey);
                if (res && typeof res === 'object' && res.ok === true) {
                    importedRecords = res.rows;
                } else {
                    showError('Не удалось загрузить новые данные на сервер\n\nВсе сделанные изменения отменены, ваша секретная фраза остается прежней!\n\nдетали ошибки: [op=restore]', res);
                    resetPasswdBtn(); // разблокируем кнопки
                    return false;
                }
                btn.textContent = `Обработка завершена`;

                // удаление старого логина и всех данных если все записи перенесены в новый
                res = await sendRequest('terminate', {}, apiUrl, login, secretKey);
                if (res && typeof res === 'object' && res.ok === true) {
                    if (debugIsOn) console.warn(`Аккаунт ${login} удален`)
                } else {
                    showError('Ошибка удаления старых данных:', res);
                }
                alert(`Секретная фраза изменена\n\nОбработано записей: ${importedRecords} из ${totalCount} шт.\n\nПрежний аккаунт и все его данные удалены. Сейчас будет выполнен вход с новой парольной фразой`);


                document.getElementById('passphrase1').value = '';
                document.getElementById('passphrase2').value = '';
                document.getElementById('secretIcons3').textContent = '';
                document.getElementById('secretIcons4').textContent = '';
                resetPasswdBtn();
                // обновим passphrase в интерфейсе
                document.getElementById('passphrase').value = newPassphrase;
                document.getElementById('passphrase').dispatchEvent(new Event('input', {bubbles: true}));
                await doLogin(newPassphrase);

            } else {
                showError('Не удалось получить данные для расшифровки\n\nВаша секретная фраза остается прежней!\n\nдетали ошибки: [op=backup]', res);
                resetPasswdBtn(); // разблокируем кнопки
                return false;
            }
        }

        function resetPasswdBtn() {
            const btn = document.getElementById('btnDoPasswd');
            btn.disabled = false;
            btn.classList.add('actionBtn');
            btn.textContent = 'Изменить секретную фразу';
            document.getElementById('btnCancelPasswd').disabled = false;
        }

        // === Restore backup show form ===
        document.getElementById('restoreBtn').onclick = async (e) => {
            e.preventDefault();
            if (!isLoggedIn || !login) {
                alert(textPleaseLoginFirst);
                return;
            }
            switchTo("restoreArea");
        }
        // === Restore backup Close button
        document.getElementById('closeRestoreBtn').onclick = (e) => {
            e.preventDefault();
            // очистка данных
            document.getElementById('fileInputBackup').value = '';
            cleanupRestore();
            switchTo(['loginArea', 'settingsArea', 'actionsArea']);
        }

        let restoreContent; //

        // === Restore file load
        document.getElementById('fileInputBackup').addEventListener('change', async (e) => {
            // очистка
            cleanupRestore();

            const file = e.target.files[0];
            if (!file) {
                return;
            }

            const info = document.getElementById('backupInfo');
            const name = file.name;
            const ext = name.split('.').pop().toLowerCase();

            let data, text;

            if (ext === 'gz') {
                // извлечем текст из архива
                try {
                    const arrayBuffer = await file.arrayBuffer();
                    text = await ungzip(arrayBuffer);
                } catch (err) {
                    info.textContent = ('Ошибка: не удалось извлечь данных из GZIP архива. Вероятно, архив поврежден!');
                    e.target.value = '';
                    return false;
                }
            } else if (ext === 'json' || ext === 'txt') {
                // загружен текстовый JSON
                text = await file.text();
            } else {
                info.textContent = ('Ошибка: архив должен быть в формате xxxxx.json.gz (сжатый) или xxxxx.json (текстовый)');
                e.target.value = '';
                return false;
            }

            try {
                data = JSON.parse(text);
            } catch (err) {
                info.textContent = ('Ошибка: не удалось разобрать данные JSON!');
                e.target.value = '';
                return false;
            }

            if (!data.date || !data.rows || !data.signature || !data.content || !Array.isArray(data.content) || data.content.length === 0) {
                info.textContent = ('Ошибка: Не удалось распознать структуру архива');
                e.target.value = '';
                return false;
            }

            // Проверка парольной фразы
            const recNum = rand(0, data.content.length - 1);
            const testText = await decryptText(data.content[recNum].rtitle, aesKey);
            if (testText === '[Corrupted data]' || testText === '[Corrupted data / invalid key]') {
                info.textContent = ('Ошибка: ваша текущая парольная фраза не подходит для этого бекапа!');
                e.target.value = '';
                return;
            }

            info.textContent = `Файл: ${name}\nДата создания: ${data.date}\nЗаписей: ${data.content.length + 1} шт.\nПодпись: ` + data.signature.slice(0, 6) + "..." + data.signature.slice(-6);
            restoreContent = data; // сохраним данные для последующей обработки
            document.getElementById('doRestoreBtn').disabled = false;
            document.getElementById('doDecryptBtn').disabled = false;
            document.getElementById('doRestoreBtn').classList.add('actionBtn');

        });

        // === Decrypt backup process
        document.getElementById('doDecryptBtn').onclick = async (e) => {
            e.preventDefault();
            if (!isLoggedIn || !login) {
                alert(textPleaseLoginFirst);
                return;
            }
            if (!confirm('Экспорт данных\n\nВыбранный архив будет расшифрован и вы сможете сохранить все записи из него в JSON (текстовом) формате\n\nХотите продолжить?')) {
                return;
            }

            const data = [];
            for (const n of restoreContent.content) {
                data.push({
                    id: n.uid,
                    date_modified: n.date_modified,
                    title: await decryptText(n.rtitle, aesKey),
                    tags: await decryptText(n.rtags, aesKey),
                    text: await decryptText(n.content, aesKey)
                });
            }
            document.getElementById('exportTextArea').value = JSON.stringify(data, null, 2); // заполним textarea
            exportCopied = false;

            // очистка
            cleanupRestore();
            switchTo('exportArea');
        }

        function cleanupRestore() {
            restoreContent = '';
            document.getElementById('backupInfo').textContent = 'файл бекапа не выбран';
            document.getElementById('doRestoreBtn').disabled = true;
            document.getElementById('doDecryptBtn').disabled = true;
            document.getElementById('doRestoreBtn').classList.remove('actionBtn');
        }

        // === Restore backup process
        document.getElementById('doRestoreBtn').onclick = async (e) => {
            e.preventDefault();
            if (!isLoggedIn || !login) {
                alert(textPleaseLoginFirst);
                return;
            }
            if (restoreContent === '' || !restoreContent.signature || !Array.isArray(restoreContent.content || restoreContent.content.length === 0)) {
                alert('Сначала выберите файл бекапа для восстановления!');
                return;
            }

            if (!confirm('Восстановление бекапа\n\nВосстановление бекапа сначала УДАЛИТ все ваши текущие данные, а затем загрузит на сервер данные из архива\n\nХотите продолжить?')) {
                return;
            }

            const b64content = base64encode(JSON.stringify(restoreContent.content));
            const res = await sendRequest('restore', {
                content: b64content,
                backup_sign: restoreContent.signature
            }, apiUrl, login, secretKey);
            if (res && typeof res === 'object' && res.ok === true) {
                alert(`Восстановлено записей (${res.rows} шт.) выполнено`);
                document.getElementById('closeRestoreBtn').click();
            } else {
                showError('Восстановление бекапа', res);
            }
        }

        // === Import data show form ===
        document.getElementById('importBtn').onclick = async (e) => {
            e.preventDefault();
            if (!isLoggedIn || !login) {
                alert(textPleaseLoginFirst);
                return;
            }
            switchTo("importArea");
        }

        // === Import file load
        document.getElementById('fileInput').addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (!file) return;
            document.getElementById('importTextArea').value = await file.text();
        });

        // === Import data process
        document.getElementById('doImportBtn').onclick = async (e) => {
            e.preventDefault();
            if (!isLoggedIn || !login) {
                alert(textPleaseLoginFirst);
                return;
            }
            const jsonStr = document.getElementById('importTextArea').value || '';
            if (jsonStr === '') {
                alert('Загрузите ваши данные JSON для импорта');
                return;
            }
            let arr = [];
            // Преобразуем строку в объект
            try {
                arr = JSON.parse(jsonStr);
            } catch (err) {
                console.error('json parse error:', err);
                alert('Не удалось разобрать данные JSON. Проверьте целостность и корректность данных.');
                return;
            }

            let importedRecords = 0;
            let errorRecords = 0;
            const totalRecords = arr.length;
            if (!confirm('Найдено записей: ' + totalRecords + 'шт. \n\nОни будут добавлены к вашим записям\n\nХотите продолжить?')) {
                return;
            }

            const results = document.getElementById('importLog');
            results.classList.remove('hidden');

            results.textContent = `Всего записей: ${totalRecords}\n\nНачинаем импорт:\n`;
            let i = 0;

            for (const item of arr) {
                i++;

                item.tags = item.tags.replace(/[\s,]+$/, ""); // trim для тегов, удалим лишнюю запятую в конце если есть

                // Кодируем данные
                const encTitle = await ENC.encodeForIndex(item.title);
                const encTags = await ENC.encodeForIndex(item.tags);
                const rEncText = await encryptText(item.text, aesKey);
                const rEncTitle = await encryptText(item.title, aesKey);
                const rEncTags = await encryptText(item.tags, aesKey);
                const operation = 'add';
                const id = '';

                // Отправляем запрос на сервер
                const res = await sendRequest(operation, {
                        id,
                        title: encTitle,
                        tags: encTags,
                        text: rEncText,
                        rtitle: rEncTitle,
                        rtags: rEncTags
                    },
                    apiUrl,
                    login,
                    secretKey);
                if (res.ok && res.id) {
                    results.textContent = results.textContent + `${i}. ID: ${res.id} - ${item.title}\n`;
                    importedRecords++;
                } else {
                    results.textContent = results.textContent + `${i}. ERROR! - ${item.title}\n`;
                    errorRecords++;
                    showError("Импорт:", res);
                }
            }
            results.textContent = results.textContent + `Импорт завершен\n\nУспешно: ${importedRecords} из ${totalRecords}\nОшибок: ${errorRecords}\n\n`;
        }

        // === Import data Close button
        document.getElementById('closeImportBtn').onclick = (e) => {
            e.preventDefault();
            document.getElementById('importTextArea').value = ''; // очистка формы
            document.getElementById('importLog').textContent = '';
            document.getElementById('importLog').classList.add('hidden');
            switchTo(['loginArea', 'settingsArea', 'actionsArea']);
        }

        document.getElementById('pasteImportBtn')?.addEventListener('click', async () => {
            const textarea = document.getElementById('importTextArea');
            if (!textarea) return;
            try {
                textarea.value = await navigator.clipboard.readText();
            } catch (err) {
                console.error('Не удалось вставить из буфера обмена:', err);
            }
        });

        // Backup data
        document.getElementById('backupBtn').onclick = async (e) => {
            e.preventDefault();
            if (!isLoggedIn || !login) {
                alert(textPleaseLoginFirst);
                return;
            }
            if (confirm('Резервное копирование\n\nВаши данные будут сохранены с сервера в зашифрованном виде, одним файлом.\n\nЭтот файл можно использовать как резервную копию для восстановления данных в будущем, а так же расшифровать и экспортировать как текст (JSON)\n\nХотите создать бэкап?')) {
                /**
                 * @typedef {Object} backupResponse
                 * @property {string} filecontent
                 * @property {boolean} ok
                 * @property {string} filename
                 */

                /** @type {backupResponse} */
                const res = await sendRequest('backup', {}, apiUrl, login, secretKey);
                if (res && typeof res === 'object' && res.ok === true) {


                    const b64 = res.filecontent;
                    const filename = res.filename;

                    const blob = new Blob(
                        [Uint8Array.from(atob(b64), c => c.charCodeAt(0))],
                        {type: "application/gzip"}
                    );

                    // создаём временную ссылку на этот blob
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;

                    // «нажимаем» ссылку программно
                    document.body.appendChild(a);
                    a.click();

                    // очищаем за собой
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                } else {
                    showError('Backup', res);
                }
            }
        }

        let exportCopied = false; // флаг, что пользователь скопировал данные экспорта

        // === Export data ===
        document.getElementById('exportBtn').onclick = async (e) => {
            e.preventDefault();
            if (!isLoggedIn || !login) {
                alert(textPleaseLoginFirst);
                return;
            }
            if (confirm('Экспорт данных\n\nВсе ваши заметки будут загружены с сервера, расшифрованы и сохранены в JSON (текстовом) формате\n\nЕсли вы хотите создать безопасную резервную копию данных - вместо "экспорта" нажмите "Скачать бекап" .\n\nХотите продолжить экспорт?')) {
                const out = document.getElementById('exportTextArea');
                if (!out) {
                    alert('Ошибка - не могу найти exportTextArea для вывода результатов');
                    return;
                }

                /**
                 * @typedef {Object} exportResponse
                 * @property {{title: string, text: string, tags: string, date_modified: string}} results
                 * @property {boolean} ok
                 * @property {number} count
                 */

                /** @type {exportResponse} */
                const res = await sendRequest('export', {}, apiUrl, login, secretKey);
                if (res && typeof res === 'object' && res.ok === true) {
                    if (!res.results || !res.results.length || !res.count) {
                        alert('Ни одной записи для экспорта не найдено');
                        return;
                    }
                    const data = [];
                    for (const n of res.results) {
                        data.push({
                            id: n.id,
                            //date_modified: n.date_modified,
                            title: await decryptText(n.title, aesKey),
                            //tags: await decryptText(n.tags, aesKey),
                            //text: await decryptText(n.text, aesKey)
                        });
                    }
                    out.value = JSON.stringify(data, null, 2); // заполним textarea
                    exportCopied = false;
                } else {
                    showError('Экспорт данных', res);
                }
                switchTo("exportArea");
            }
        }

        // === Export data Close button
        document.getElementById('closeExportBtn').onclick = (e) => {
            e.preventDefault();
            if (exportCopied || confirm('Вы скопировали / сохранили данные?')) {
                document.getElementById('exportTextArea').value = ''; // очистка формы
                switchTo(['loginArea', 'settingsArea', 'actionsArea']);
            }
        }

        // === Export data Copy button
        document.getElementById('copyExportBtn')?.addEventListener('click', () => {
            const txt = document.getElementById('exportTextArea')?.value || '';
            navigator.clipboard.writeText(txt);
            alert('Скопировано\n\nСохраните данные (например в TXT файл) для дальнейшего использования');
            exportCopied = true;
        });

        // Export data Save button
        document.getElementById('saveExportBtn').addEventListener('click', () => {
            const text = document.getElementById('exportTextArea').value || '';
            const filename = 'export_data.txt';

            // создаём Blob (объект файла)
            const blob = new Blob([text], {type: 'text/plain;charset=utf-8'});

            // создаём временную ссылку на этот blob
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;

            // «нажимаем» ссылку программно
            document.body.appendChild(a);
            a.click();
            exportCopied = true;

            // очищаем за собой
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });

        // === Логин ===
        document.getElementById('loginForm').addEventListener('submit', async e => {
            e.preventDefault();
            let passphrase = document.getElementById('passphrase').value;
            if (!passphrase) {
                alert('Секретная фраза не найдена!');
                return;
            }
            await doLogin(passphrase);
        });

        // === Поиск ===
        document.getElementById('searchForm').addEventListener('submit', async e => {
            e.preventDefault();

            const query = document.getElementById('searchQuery').value.replace(/[\s,]+$/, ""); // Удалим запятую в конце
            if (!query) return;
            const normalizedQuery = String(query).toLowerCase();
            const allWords = ['все', 'всё'];
            const encQuery = (allWords.includes(normalizedQuery)) ? "ALL" : await ENC.encodeForIndex(query);
            const res = await sendRequest('search', {query: encQuery}, apiUrl, login, secretKey);
            if (res && typeof res === 'object' && res.ok === true) {
                await showResults(res);
            } else {
                showError('search', res);
            }
        });

        async function genKeys(passphrase) {
            let encryptionKey = await deriveClientKeyHex(passphrase, await sha256(passphrase), 100000); // делаем "дорогим" прямой перебор
            let encryptionKey2 = await sha256(encryptionKey); // "второй" хеш
            const secretKey = encryptionKey2.slice(-15); // последние 15 символов
            encryptionKey2 = await sha256(encryptionKey2); // "второй" хеш
            const aesSalt = encryptionKey2.slice(-15); // соль для шифрования - 15 знаков
            encryptionKey2 = await sha256(encryptionKey2); // "второй" хеш
            const login = encryptionKey2.slice(-15); // идентификатор пользователя - 15 знаков
            const aesKey = await getAesKey(encryptionKey, aesSalt);
            const ENC = await makeEncState(encryptionKey); // Инициация детерминированного шифрования
            return [login, secretKey, aesKey, ENC];
        }

        async function doLogin(passphrase) {
            if (savedSavePassphrase) {
                // Сохраним введенную секретную фразу
                sessionStorage.setItem('passphrase', passphrase);
            }
            apiUrl = selectApiServer.value;

            [login, secretKey, aesKey, ENC] = await genKeys(passphrase); // установка глобальных переменных

            // Отладка
            if (debugIsOn) {
                const debug = document.getElementById('debug');
                debug.textContent = '';
                debug.textContent += `Login: ${login}\nSecret_key: ${secretKey}\n`;
            }

            // логин
            /**
             * @typedef {Object} LoginResponse
             * @property {boolean} ok
             * @property {number} records
             * @property {string} error
             * @property {number} signup
             */

            /** @type {LoginResponse} */
            const res = await sendRequest('login', {}, apiUrl, login, secretKey);
            if (res && typeof res === 'object' && res.ok === true) {
                if (debugIsOn) console.log(`Вход выполнен на ${apiUrl} как ${login}, записей в базе: ${res.records}`);
            } else if (res && typeof res === 'object' && res.error === 'user_not_registered') {
                if (res.signup === 1) {
                    if (!await doSignup(apiUrl, login, secretKey)) {
                        switchTo(['loginArea', 'settingsArea']);
                        return false;
                    }
                } else {
                    // Пользователь не зарегистрирован, регистрация не разрешена
                    alert(`Такой пользователь не зарегистрирован на сервере и сервер не разрешает новые регистрации\n\nДля регистрации сообщите администратору ваши\n- ID: ${login}\n- SecretKey: ${secretKey}\n\n(можно скопировать из данных отладки)`);
                    if (debugIsOn) console.warn(`Пользователь ${login} с ключом ${secretKey} не существует на сервере ${apiUrl}. Регистрация не доступна.`);
                    switchTo(['loginArea', 'settingsArea']);
                    return false;
                }

            } else {
                showError("Login error", res);
                switchTo(['loginArea', 'settingsArea']);
                return false;
            }

            isLoggedIn = true; // установим флаг успешного логина
            document.getElementById('btnLogout').classList.remove('hidden');
            document.getElementById('passwdBtn').disabled = false;
            document.getElementById('exportBtn').disabled = false;
            document.getElementById('backupBtn').disabled = false;
            document.getElementById('restoreBtn').disabled = false;
            document.getElementById('importBtn').disabled = false;
            document.getElementById('terminateAccountBtn').disabled = false;

            // Изменения в интерфейсе после инициализации и логина
            document.getElementById('searchQuery').value = ''; // очистка поля поиска

            let lastSwitch = sessionStorage.getItem('lastSwitch');
            let lastViewID = sessionStorage.getItem('lastViewID');
            let lastEditID = sessionStorage.getItem('lastEditID');

            // Восстановим последнее действие, если оно было
            if (lastSwitch === 'viewArea' && lastViewID) {
                // откроем заново просмотр заметки
                await viewNote(lastViewID);
            } else if (lastSwitch === 'editArea' && lastEditID) {
                // откроем заново форму редактирования
                await viewNote(lastEditID);
                document.getElementById('btnActionEdit').click();
            } else {
                switchTo(['searchArea', 'loginInfo']);
                document.getElementById('searchQuery').focus();
            }
        }

        async function showResults(res) {
            const container = document.getElementById('searchResultsList');
            container.classList.remove('hidden'); // покажем область результатов поиска
            container.innerHTML = '';

            if (!res || typeof res !== 'object' || !res.results || !res.results.length) {
                const empty = document.createElement('i');
                empty.textContent = 'Ничего не найдено';
                container.appendChild(empty);
                return;
            }

            // есть результаты поиска
            container.innerHTML = "<div class='align-right'><a href='#' id='clearResultLink'>Очистить результаты</a></div>";
            const clearResultLink = document.getElementById('clearResultLink');
            if (clearResultLink) {
                clearResultLink.addEventListener('click', (event) => {
                    event.preventDefault();
                    document.getElementById('searchQuery').value = '';
                    document.getElementById('searchQuery').focus();
                    container.innerHTML = '';
                    container.classList.add('hidden');
                });
            }

            for (const n of res.results) {
                const div = document.createElement('div');
                div.className = 'note';
                div.id = `note${n.id}`;
                const title = await decryptText(n.title, aesKey);
                const linkOpen = document.createElement('a');
                linkOpen.href = '#';
                linkOpen.className = 'action-link';
                linkOpen.textContent = title;
                linkOpen.addEventListener('click', (e) => {
                    e.preventDefault();
                    viewNote(n.id);
                });
                div.append(linkOpen);
                container.appendChild(div);
            }
        }

        // === Добавление ===
        document.getElementById('btnNew').onclick = () => {
            document.getElementById('editTitle').textContent = "Новая запись";
            document.getElementById('editId').value = '';
            document.getElementById('editTitleInput').value = '';
            document.getElementById('editTagsInput').value = '';
            document.getElementById('editTextInput').value = '';
            document.getElementById('editTextInput').defaultValue = '';
            makeWysiwyg('editTextInput');
            switchTo('editArea');
            setHash('new');
            document.getElementById('editTitleInput').focus();
        };

        // ==== Нажата кнопка Отмена на странице редактирования
        document.getElementById('btnCancelEdit').onclick = () => {
            document.getElementById('editForm').reset(); // отмена изменений в текст
            const id = document.getElementById('editId').value;
            if (id) {
                sessionStorage.removeItem('lastEditID');
                switchTo('viewArea');
                sessionStorage.setItem('lastViewID', id);
                setHash('view:' + id);
            } else {
                switchTo(['searchArea', 'loginInfo']);
                if (!document.getElementById('searchQuery').value) {
                    document.getElementById('searchQuery').focus();
                }
            }
        };

        // Обработка отправка формы добавления / редактирования записи
        document.getElementById('editForm').onsubmit = async e => {
            e.preventDefault();
            if (debugIsOn) console.log('submit form to server');
            const id = document.getElementById('editId').value;
            const title = document.getElementById('editTitleInput').value;
            let tags = document.getElementById('editTagsInput').value;
            const text = document.getElementById('editTextInput').value;

            tags = tags.replace(/[\s,]+$/, ""); // trim для тегов, удалим лишнюю запятую в конце если есть

            // Проверка, заполнены ли все поля
            if (!title || !tags || !text) {
                alert('Все поля должны быть заполнены!');
                return;
            }

            // Кодируем данные
            const encTitle = await ENC.encodeForIndex(title);
            const encTags = await ENC.encodeForIndex(tags);
            const rEncText = await encryptText(text, aesKey);
            const rEncTitle = await encryptText(title, aesKey);
            const rEncTags = await encryptText(tags, aesKey);
            const operation = id ? 'modify' : 'add';

            // Отправляем запрос на сервер
            const res = await sendRequest(operation, {
                    id,
                    title: encTitle,
                    tags: encTags,
                    text: rEncText,
                    rtitle: rEncTitle,
                    rtags: rEncTags
                },
                apiUrl,
                login,
                secretKey);
            if (res && typeof res === 'object' && res.ok === true && res.id) {

                // Изменения в форму добавления
                sessionStorage.removeItem('lastEditID');
                await viewNote(res.id);
                return;
            }
            showError(operation, res);
        };

        // === Удаление ===
        async function deleteNote(id) {
            if (!confirm("Удалить запись " + id + "?")) return;
            const res = await sendRequest('delete', {id}, apiUrl, login, secretKey);
            if (res && typeof res === 'object' && res.ok === true) {
                switchTo(['searchArea', 'loginInfo']);
                if (document.getElementById('searchQuery').value) {
                    await document.getElementById('searchBtn').click();
                } else {
                    document.getElementById('searchQuery').focus();
                }
                sessionStorage.removeItem('lastViewID'); // "Забудем" ID
            } else {
                showError('delete', res);
            }
        }


        // === Просмотр и форма редактирования ===
        async function viewNote(id) {

            /**
             * @typedef {Object} GetResponse
             * @property {{title: string, text: string, tags: string, date_modified: string}} note
             */

            /** @type {GetResponse} */
            const res = await sendRequest('get', {id}, apiUrl, login, secretKey);
            if (res && typeof res === 'object' && res.note && typeof res.note === 'object') {

                let noteDate = (res.note.date_modified) ? formatDate(res.note.date_modified, 'd.m.y H:i') : '';
                let noteContent = (res.note.content) ? await decryptText(res.note.content, aesKey) : '';
                let noteTitle = (res.note.rtitle) ? await decryptText(res.note.rtitle, aesKey) : '';
                let noteTags = (res.note.rtags) ? await decryptText(res.note.rtags, aesKey) : '';

                // Обработка текста
                let noteContentView = bbcodeToHtml(noteContent);

                // Заполняем форму редактирования
                document.getElementById('editTitle').textContent = `Редактирование записи ${id}`;
                document.getElementById('editId').defaultValue = id;
                document.getElementById('editTitleInput').defaultValue = noteTitle;
                document.getElementById('editTagsInput').defaultValue = noteTags;
                document.getElementById('editTextInput').defaultValue = noteContent;
                document.getElementById('editId').value = id;
                document.getElementById('editTitleInput').value = noteTitle;
                document.getElementById('editTagsInput').value = noteTags;
                document.getElementById('editTextInput').value = noteContent;
                makeWysiwyg('editTextInput');

                // Заполняем форму просмотра
                document.getElementById('viewTitle').textContent = noteTitle;
                document.getElementById('viewContent').innerHTML = noteContentView;
                document.getElementById('viewDate').textContent = noteDate + ', ID #' + id;
                document.getElementById('viewTags').innerHTML = formatTags(noteTags, 'tag-label');

                // Кнопка закрытия
                document.getElementById('btnActionClose').onclick = () => {
                    // очистим форму редактирования
                    document.getElementById('editTitle').textContent = '';
                    document.getElementById('editId').value = '';
                    document.getElementById('editTitleInput').value = '';
                    document.getElementById('editTagsInput').value = '';
                    document.getElementById('editTextInput').value = '';
                    document.getElementById('editTitleInput').defaultValue = '';
                    document.getElementById('editTagsInput').defaultValue = '';
                    document.getElementById('editTextInput').defaultValue = '';
                    // очистим форму просмотра
                    document.getElementById('viewTitle').textContent = '';
                    document.getElementById('viewContent').textContent = '';
                    document.getElementById('viewTags').textContent = '';
                    // обновляем результаты поиска
                    switchTo(['searchArea', 'loginInfo']);
                    if (document.getElementById('searchQuery').value) {
                        document.getElementById('searchBtn').click();
                    } else {
                        document.getElementById('searchQuery').focus();
                    }
                    sessionStorage.removeItem('lastViewID'); // "Забудем" ID
                }

                // Кнопка редактирования
                document.getElementById('btnActionEdit').onclick = () => {
                    switchTo('editArea');
                    setHash('edit:' + id);
                    document.getElementById('editTitleInput').focus();
                    sessionStorage.removeItem('lastViewID'); // "Забудем" ID
                    sessionStorage.setItem('lastEditID', id);
                }

                // Кнопка удаления
                document.getElementById('btnActionDelete').onclick = () => deleteNote(id);

                // Активируем обработчик внутренних ссылок
                initInternalLinks();
                // Показываем форму просмотра
                switchTo('viewArea');
                if (location.hash !== '#view:' + id) {
                    setHash('view:' + id);
                }

                // Сохраним id заметки на случай перезагрузки страницы
                sessionStorage.setItem('lastViewID', id);

            } else {
                showError('get', res);
            }

        }

        function switchTo(activeIds) {
            if (debugIsOn) console.log('switchTo ' + activeIds);
            // Список всех id, с которыми работает функция
            const ids = ["viewArea", "searchArea", "editArea", "loginArea", "helpArea", "actionsArea", "settingsArea", "exportArea", "importArea", "loginInfo", "passwdArea", "textArea", "restoreArea"];

            // Преобразуем параметр в массив, если это не массив
            const activeList = Array.isArray(activeIds) ? activeIds : [activeIds];

            // Пройтись по списку и скрыть все элементы
            ids.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    // Если этот id присутствует в списке активных — показываем, иначе скрываем
                    if (activeList.includes(id)) {
                        el.classList.remove('hidden');
                    } else {
                        el.classList.add('hidden');
                    }
                }
            });

            activeArea = activeList[0] || ''; // установим флаг какая область сейчас активна

                // Убрать hash страницы
            setHash('');

            // Запомнить последние активные области
            sessionStorage.setItem('lastSwitch', activeList[0] || '');
        }

        // Подключаем подсказки автозавершения для поиска и тегов
        initTagAutocomplete('searchQuery');
        initTagAutocomplete('editTagsInput');

        // Инициализация "просмотра пароля" после загрузки DOM
        document.addEventListener('DOMContentLoaded', initPasswordToggles);

        // Обработка изменения хеша
        if (saveHistory) {
            window.addEventListener('hashchange', () => {
                const hash = location.hash.slice(1); // убираем #
                if (debugIsOn) console.log('Hash изменился:', hash);

                if (hash === '') {
                    switchTo(['searchArea', 'loginInfo']);
                    return;
                }
                // если формат view:123
                const [action, id] = hash.split(':');
                if (action === 'view' && id) {
                    viewNote(id);
                }
            });
        }

        function escHandler(event) {
            if(activeArea === 'viewArea') {
                if (event.key === "Escape") {
                    document.getElementById("btnActionClose").click();
                    return;
                }
            }
            if(activeArea === 'importArea') {
                if (event.key === "Escape") {
                    document.getElementById("closeImportBtn").click();
                    return;
                }
            }
            if(activeArea === 'exportArea') {
                if (event.key === "Escape") {
                    document.getElementById("closeExportBtn").click();
                    return;
                }
            }
            if(activeArea === 'passwdArea') {
                if (event.key === "Escape" && document.getElementById("btnCancelPasswd").disabled === false) {
                    document.getElementById("btnCancelPasswd").click();
                    return;
                }
            }
             if(activeArea === 'loginArea') {
                if (event.key === "Escape" && !document.getElementById("settingsArea").classList.contains('hidden')) {
                    document.getElementById("settingsArea").classList.add('hidden');
                    document.getElementById("actionsArea").classList.add('hidden');
                    return;
                }
            }
            if(activeArea === 'textArea') {
                if (event.key === "Escape") {
                    document.getElementById("closeTextBtn").click();
                    return;
                }
            }
            if(activeArea === 'restoreArea') {
                if (event.key === "Escape") {
                    document.getElementById("closeRestoreBtn").click();
                    return;
                }
            }
            if(activeArea === 'editArea') {
                if (event.key === "Escape") {
                    title = document.getElementById('editTitleInput').value;
                    tags = document.getElementById('editTagsInput').value;
                    if( (title === '' && tags === '') || confirm('Закрыть форму?')) {
                        document.getElementById("btnCancelEdit").click();
                    }
                    return;
                }
            }
            if(activeArea === 'searchArea') {
                if (event.key === "Escape") {
                    if(document.getElementById('searchResultsList').textContent === '') return;
                    const box = document.querySelector('.autocomplete-box');
                    if (box && box.style.display !== 'none') {
                        return;
                    }
                    document.getElementById("clearResultLink").click();
                    return;
                }
            }
        }

        document.addEventListener("keydown", escHandler, { capture: true });

    </script>
</div>
</body>
</html>
